# Rucola Maze: веб-приложение на Flask, которое ведет учет продуктов и покупок в ресторане

[Video Demo](https://youtu.be/kAdhWCasBZo) -- на русском

[Video Demo](https://youtu.be/FuucjgUQ8Vg) -- English

## Инструменты

Flask (Blueprints, Jinja), Python, SQLite, WTForms и BootStrap.

## Назначение

Приложение выполняет следующие функции:
- отслеживает поступление продуктов в ресторан;
- учитывает расход продуктов при покупке;
- определяет, в наличии ли те или иные пункты меню (проверяет каждый ингредиент);
- автоматически подсчитывает выручку и прибыль.
Чтобы работать с приложением, нужно зарегистрироваться.

## Структура

Приложение состоит из двух суб-приложений, каждое из которых представляет собой отдельный Flask Blueprint:

- 'inventory', которое осуществляет все операции с ингредиентами, пунктами меню и покупками. У URL-адресов здесь нет префиксов, поскольку это приложение более важное;
- 'auth', которое отвечает за авторизацию и аутентификацию пользователей. URL-адреса начинаются с 'auth'.

У каждого из суб-приложений отдельный файл с views ('inventory.py' и 'auth.py'), а также отдельная папка с шаблонами. Суб-приложения связаны через файл ' \_\_init\_\_.py', в котором находится фабрика приложений. 

## Модели

Всего 4 модели, помимо User: **Ingredient, MenuItem** ("Пункт меню", т.е. блюдо), **RecipeRequirement** ("Требование рецепта") и **Purchase** ("Покупка"). Модели Ingredient и MenuItem связаны через RecipeRequirement следующим образом: каждое требование рецепта (RecipeRequirement) показывает, какой ингредиент и в каком количестве требуется для определенного пункта меню (MenuItem).

Таким образом, каждый пункт меню (MenuItem) потенциально имеет несколько требований рецепта (RecipeRequirement), а отдельно взятое требование рецепта (RecipeRequirement) имеет связь только с одним ингредиентом (Ingredient) и одним пунктом меню (MenuItem).

## Как пользоваться приложением

### Страничка "Ингредиенты"

Здесь перечислены все ингредиенты: название, количество и цена за единицу. Пользователь может совершать следующие действия:

- добавлять ингредиенты, используя соответствующую кнопку вверху странички;
- редактировать или удалять ингредиенты, используя кнопки напротив названия;

Информация о действиях пользователя с ингредиентами собирается через формы WTF. Сообщения об ошибке и подтверждение действий пользователя выводит функция Flask "flash". 

Cообщения вида "Вы добавили ингредиент 'яйцо', цена: 20 руб. штука." представляются полезными, поскольку, чем длинее таблица, тем неудобнее пользователю каждый раз проверять, успешно ли было его последнее действие. Кроме того, когда нужно добавить несколько ингредиентов, пользователь может напутать и попытаться повторно добавить тот же ингредиент. Сообщения позволяют пользователю сразу заметить опечатки, а в случае попытки добавить ингредиент повторно объясняет пользователю, что пошло не так.

### Страничка "Меню"

Здесь перечислены все пункты меню: 
- название;
- цена;
- все требования рецепта (т.е. какие ингредиенты и в каком количестве нужны для того, чтобы приготовить это блюдо);
- можно ли это блюдо сейчас заказать (т.е. все ли ингредиенты в наличии).

По колонке "В наличии" сотрудники ресторана сразу видят, что можно предложить клиенту, и им не нужно для этого посещать еще какие-то странички. Откуда появляется информация в этой колонке, мы разберем в разделе "Как мы проверяем, в наличии ли тот или иной пункт меню?" 

Пункты меню можно добавлять, редактировать или удалять так же точно, как ингредиенты.

### Страничка "Требования рецептов"

У каждого пункта меню есть одно или несколько требований рецепта. Каждое требование рецепта связывает один пункт меню с одним ингредиентом, а также содержит информацию о том, сколько этого ингредиента необходимо для приготовления данного пункта меню.

В формах "Редактировать и "Удалить" для требований рецептов есть динамическое поле Select, в котором отображаются имеющиеся в наличии пункты меню и ингредиенты.

### Как мы проверяем, в наличии ли тот или иной пункт меню?

У модели RecipeRequirement есть метод 'in_stock()' ("достаточный запас"), который проверяет, можно ли в данный момент выполнить данное требование рецепта. Иными словами, метод делает следующее:

1. Берет две величины:

- MenuItem.RecipeRequirement -> RecipeRequirement.Ingredient -> Ingredient.quantity_available
- MenuItem.RecipeRequirement.quantity_required

2. Проверяет, чтобы первая величина не была меньше, чем вторая.

Метод возвращает булево значение, которое является ответом на вопрос: "Достаточно ли у нас данного ингредиента, чтобы приготовить данное блюдо?"

Поскольку для приготовления одного пункта меню, как правило, нужно несколько ингредиентов, нам нужно будет проверить несколько требований рецептов. Именно это делает метод 'is_available()' модели MenuItem. Сначала этот метод создает список всех требований рецептов для конкретного пункта меню ('rr_availability_list'). Далее, он проверяет, все ли ингредиенты, что указаны в требованиях рецептов, есть в достаточном количестве, и возвращает булево значение.

### Страничка "Покупки"

Здесь перечислены все покупки (заказы), которые уже были сделаны: название пункта меню и время. Можно удалять покупки и добавлять новые.

Форма "Добавить покупку" отображает только те пункты меню, которые сейчас есть в наличии (для которых есть ингредиенты). Благодаря этому исключены ситуации, когда клиент решает что-то заказать, и тут выясняется, что для данного блюда не хватает ингредиентов.

#### Что происходит при покупке?

Как только форма "Добавить покупку" отправлена, требуемое количество каждого ингредиента вычитается из того количества, которое есть в наличии. Результат отображается в  колонке "Доступное количество" на страничке "Ингредиенты". Если в результате какой-либо из пунктов меню становится недоступным для заказа, это отображается на страничке "Меню".

Когда вы добавляете покупку, это значит, что блюдо было "приготовлено" (ингредиенты вычтены), поэтому вы не можете редактировать покупку. Можно только полностью удалить покупку, и тогда она не будет отображаться при расчете выручки/прибыли. Это значит, что, хотя блюдо было "приготовлено" (ингредиенты вычтены), ресторан не получил оплату. Т.е. клиент блюдо получил, но отказался платить.

### Подсчет выручки и прибыли

На домашней страничке отображаются три значения:

- общая выручка (сумма всех зарегистрированных покупок);
- общая стоимость покупок (суммируем стоимость всех использованных ингредиентов);
- прибыль (выручка минус стоимость).